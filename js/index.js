var rating = "https://raw.githubusercontent.com/asozialesnetzwerk/zitate/master/bewertung_zitate.json";
var authors = "https://raw.githubusercontent.com/asozialesnetzwerk/zitate/master/namen.txt";
var quotes = "https://raw.githubusercontent.com/asozialesnetzwerk/zitate/master/zitate.txt";

window.q = [];
window.r = [];

function getUrlVars() {
    var vars = {};
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
        vars[key] = value;
    });
    return vars;
}

function getUrlParam(parameter, defaultvalue){
    var urlparameter = defaultvalue;
    if(window.location.href.indexOf(parameter) > -1) {
        urlparameter = getUrlVars()[parameter];
    }
    return urlparameter;
}

function displayZitat(id) {
    var ids = id.split("-");
    
    var theQuote = window.q[1][ids[0]];
    var theAuthor = window.q[0][ids[1]];
    var rating = window.r[0][id];
    if(rating === undefined) rating = "0";
    
    $(".quote-text").text(theQuote);
    $(".quote-author").text("- " + theAuthor);
    $(".quote-id").text(id);
    $(".quote-rating").text("Rating: "+ rating);

    $(".tweet").attr("href", "https://twitter.com/intent/tweet?text=" + encodeURIComponent(theQuote + ' - ' + theAuthor + "\nID: "+id+" Generated by https://asozialesnetzwerk.github.io/zitate"));
}

function createZitat() {
    var z;
    while (window.r[0][z] === undefined || window.r[0][z] <= 0) { //Bis positive Zitate gefunden
        z = Math.floor(Math.random() * window.q[1].length) + "-" + Math.floor(Math.random() * window.q[0].length); //Zitat-ID
    }
    var end = window.location.href.lastIndexOf('?');
    if(end < 0) end = window.location.href.length;
    window.location = window.location.href.substring(0, end) + "?tag=" + z;
}

function checkLoad() {
    if (window.q.length == 2 && window.r.length == 1) {
        var id = getUrlParam("tag", "");
        if(id.indexOf('-') < 1) createZitat(); 
        else displayZitat(id);
    } 
}

var getQuote = function (data) {
    window.q.push(data.split(/\n/));
    checkLoad();
};

var getRating = function (data) {
    window.r.push(JSON.parse(data));
    checkLoad();
};


$(".get-quote").on("click", function () {
    createZitat();
});

$.get(rating, getRating, 'text');
$.get(authors, getQuote, 'text');
$.get(quotes, getQuote, 'text');
